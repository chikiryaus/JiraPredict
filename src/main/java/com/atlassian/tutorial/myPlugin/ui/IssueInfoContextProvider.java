package com.atlassian.tutorial.myPlugin.ui;

import com.atlassian.jira.issue.Issue;
import com.atlassian.jira.plugin.webfragment.contextproviders.AbstractJiraContextProvider;
import com.atlassian.jira.plugin.webfragment.model.JiraHelper;
import com.atlassian.jira.user.ApplicationUser;
import com.atlassian.jira.issue.fields.CustomField; // Для класса CustomField
import com.atlassian.jira.component.ComponentAccessor; // Для класса ComponentAccessor

import java.util.HashMap;
import java.util.Map;

// ?????: ???? ????? ?? ??????????? ?????? ???? @Named,
// ??? ??? ?? ??????????? ???????? ? atlassian-plugin.xml
// ? ????????? ??????????? ???-??????????.
// ?? ??? ????? ????????????? ???????????, ??????? ????? ????????,
// ????? ??? ????? ??????? @Named ? ???????? ??????????? ????? ???????????.
// ???? ?? ???????, ??????? ???.
public class IssueInfoContextProvider extends AbstractJiraContextProvider {



    // ??????????? ?? ?????????
    public IssueInfoContextProvider() {
        // ???? ????? ??????????? (????????, ??? PredictionService),
        // ???????? ?? ??? ???? ? ???????? ??????????? ? @Inject
    }

    @Override
    public Map<String, Object> getContextMap(ApplicationUser user, JiraHelper jiraHelper) {
        Map<String, Object> contextMap = new HashMap<>();

        // ???????? ??????? ?????? Issue ?? ????????? JiraHelper
        Issue currentIssue = (Issue) jiraHelper.getContextParams().get("issue");

        // ?????????, ??? ?????? ????????
        if (currentIssue != null) {

            // ?????? ?????? ?????? ?? ??????? Issue ? contextMap
            // ????? ???? ????? ??????? ?????????? ? Velocity-???????

            contextMap.put("issueKey", currentIssue.getKey()); // ???? ?????? (e.g., MYPROJ-123)
            contextMap.put("issueSummary", currentIssue.getSummary()); // ????????? ??????
            contextMap.put("issueTypeName", currentIssue.getIssueType().getName()); // ???????? ???? ?????? (e.g., "Bug")
            contextMap.put("issuePriorityName", currentIssue.getPriority() != null ? currentIssue.getPriority().getName() : "None"); // ???????? ?????????? (????????? ?? null)
            contextMap.put("issueProjectName", currentIssue.getProjectObject().getName()); // ???????? ???????
            contextMap.put("issueProjectId", currentIssue.getProjectObject().getId()); // ID ???????
            contextMap.put("issueStatusName", currentIssue.getStatus().getName()); // ???????? ???????? ???????
            contextMap.put("issueReporterName", currentIssue.getReporter() != null ? currentIssue.getReporter().getDisplayName() : "None"); // ???????????? ??? ?????? (????????? ?? null)
            contextMap.put("issueAssigneeName", currentIssue.getAssignee() != null ? currentIssue.getAssignee().getDisplayName() : "Unassigned"); // ???????????? ??? ??????????? (????????? ?? null)
            contextMap.put("issueCreatedDate", currentIssue.getCreated()); // ???? ???????? (java.sql.Timestamp)
            contextMap.put("issueUpdatedDate", currentIssue.getUpdated()); // ???? ?????????? ?????????? (java.sql.Timestamp)
            contextMap.put("issueResolutionDate", currentIssue.getResolutionDate()); // ???? ??????? (java.sql.Timestamp, ????? null, ???? ?? ??????)

             CustomField myCustomField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("customfield_10001"); // ???????? ID!
             Object customFieldValue = currentIssue.getCustomFieldValue(myCustomField);
             contextMap.put("myCustomFieldValue", customFieldValue != null ? customFieldValue.toString() : "N/A");



        } else {
            // ????? ???????? ???? ?????? ? ????, ????? ?????? ???? ?? ????
            contextMap.put("error", "Could not load issue data.");
        }


        return contextMap;
    }
}